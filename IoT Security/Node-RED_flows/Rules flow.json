[{"id":"2165caf7.2f0b96","type":"tab","label":"Rules Flow","disabled":false,"info":""},{"id":"c83b7445.bb40d8","type":"comment","z":"2165caf7.2f0b96","name":"Rules","info":"\n**ATM Jackpotting**\nRule 1: Temperature over 59°C + Brightness under 400 //cambiata con brightness alta\nRule 2: Noise under 500 + Brightness under 400 // al contrario\nRule 3: Temperature over 59°C + Motion detected //uguale\nRule 4: Noise under 500 + Motion detected // rumore alto\nRule 5: Jammer detected under 400 or over 600\n\n**Physical Attack**\nRule 1: GPS movement detected\nRule 2: Gyroscope over 10000 + Accelerometer over 10000","x":70,"y":60,"wires":[]},{"id":"2f57c29c.d079ee","type":"function","z":"2165caf7.2f0b96","name":"Rule 1","func":"var brightnessValue=global.get(\"brightnessValue\");\nvar temperatureValue= global.get(\"temperatureValue\");\nvar brightnessArray= global.get(\"brightnessArray\");\nvar temperatureArray= global.get(\"temperatureArray\");\nvar completeCheck= global.get(\"completeCheck\");\nvar isAlarmOn= global.get(\"isAlarmOn\");\nvar msg1={payload:\"okrule1\"};\n\nif (completeCheck\n    && !isAlarmOn\n    && temperatureValue > computeThreshold(temperatureArray,\"high\") \n    && brightnessValue > computeThreshold(brightnessArray,\"high\")) {\n        msg1={payload:\"05rule1\"};\n        global.set(\"isAlarmOn\", true);\n    }\n\nreturn msg1;\n\nfunction computeThreshold(array,type) {\n    var q2 = getMedian(array);\n    var q1 = getMedian( array.slice(0, q2[0]+1) );\n    var q3 = getMedian( array.slice(q2[0]+1, array.length) );\n    var iqr = q3[1] - q1[1]; //The interquartile range\n    var tlo = q1[1] - 1.5 * iqr ;//low threshold\n    var thi = q3[1] + 1.5 * iqr ;//high threshold\n    if (type == \"high\") {\n        return thi + (thi/100*20);\n    }\n    return tlo;\n}\n\nfunction getMedian (m) {\n    var middle = Math.floor((m.length - 1) / 2); // NB: operator precedence\n    if (m.length % 2) {\n        return [middle, m[middle]];\n    } else {\n        return [middle, (m[middle] + m[middle + 1]) / 2.0];\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":180,"wires":[["cb83197e.0028a8"]]},{"id":"7c2c3337.05c06c","type":"function","z":"2165caf7.2f0b96","name":"Rule 2","func":"var brightnessValue= global.get(\"brightnessValue\");\nvar brightnessArray= global.get(\"brightnessArray\");\nvar microphoneValue= global.get(\"microphoneValue\");\nvar microphoneArray= global.get(\"microphoneArray\");\nvar completeCheck= global.get(\"completeCheck\");\nvar isAlarmOn= global.get(\"isAlarmOn\");\n\nvar msg1;\nmsg1={payload:\"okrule2\"};\nif( completeCheck && !isAlarmOn\n    && microphoneValue > computeThreshold(microphoneArray,\"high\")\n    && brightnessValue > computeThreshold(brightnessArray,\"high\")) {\n    msg1={payload:\"05rule2\"};\n    global.set(\"isAlarmOn\", true);\n}\nreturn msg1;\n\nfunction computeThreshold(array,type) {\n    var q2 = getMedian(array);\n    var q1 = getMedian( array.slice(0, q2[0]+1) );\n    var q3 = getMedian( array.slice(q2[0]+1, array.length) );\n    var iqr = q3[1] - q1[1]; //The interquartile range\n    var tlo = q1[1] - 1.5 * iqr ;//low threshold\n    var thi = q3[1] + 1.5 * iqr ;//high threshold\n    if (type == \"high\") {\n        return (thi + (thi/100*20));\n    }\n    return tlo;\n}\n\nfunction getMedian (m) {\n    var middle = Math.floor((m.length - 1) / 2); // NB: operator precedence\n    if (m.length % 2) {\n        return [middle, m[middle]];\n    } else {\n        return [middle, (m[middle] + m[middle + 1]) / 2.0];\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":240,"wires":[["8a1f2d0.722b8d"]]},{"id":"d1348304.cd819","type":"function","z":"2165caf7.2f0b96","name":"Rule 3","func":"var motionValue= global.get(\"motionValue\");\nvar temperatureValue= global.get(\"temperatureValue\");\nvar temperatureArray= global.get(\"temperatureArray\");\nvar completeCheck= global.get(\"completeCheck\") || false;\nvar isAlarmOn= global.get(\"isAlarmOn\");\n\nvar msg1;\nmsg1={payload:\"okrule3\"};\n\nif( completeCheck\n    && !isAlarmOn\n    && temperatureValue > computeThreshold(temperatureArray,\"high\")\n    && motionValue > 0) {\n    msg1={payload:\"05rule3\"};\n    global.set(\"isAlarmOn\", true);\n}\nreturn msg1;\n\nfunction computeThreshold(array,type) {\n    var q2 = getMedian(array);\n    var q1 = getMedian( array.slice(0, q2[0]+1) );\n    var q3 = getMedian( array.slice(q2[0]+1, array.length) );\n    var iqr = q3[1] - q1[1]; //The interquartile range\n    var tlo = q1[1] - 1.5 * iqr ;//low threshold\n    var thi = q3[1] + 1.5 * iqr ;//high threshold\n    if (type == \"high\") {\n        return (thi + (thi/100*20));\n    }\n    return tlo;\n}\n\nfunction getMedian (m) {\n    var middle = Math.floor((m.length - 1) / 2); // NB: operator precedence\n    if (m.length % 2) {\n        return [middle, m[middle]];\n    } else {\n        return [middle, (m[middle] + m[middle + 1]) / 2.0];\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":300,"wires":[["276b4828.dcdf38"]]},{"id":"3340b93d.7d7ea6","type":"function","z":"2165caf7.2f0b96","name":"Rule 4","func":"var motionValue= global.get(\"motionValue\");\nvar microphoneValue= global.get(\"microphoneValue\");\nvar microphoneArray= global.get(\"microphoneArray\");\nvar completeCheck= global.get(\"completeCheck\") || false;\nvar isAlarmOn= global.get(\"isAlarmOn\");\n\nvar msg1;\nmsg1={payload:\"okrule4\"};\n\nif( completeCheck\n    && !isAlarmOn\n    && microphoneValue > computeThreshold(microphoneArray,\"high\")\n    && motionValue > 0) {\n    msg1={payload:\"05rule4\"};\n    global.set(\"isAlarmOn\", true);\n}\nreturn msg1;\n\nfunction computeThreshold(array,type) {\n    var q2 = getMedian(array);\n    var q1 = getMedian( array.slice(0, q2[0]+1) );\n    var q3 = getMedian( array.slice(q2[0]+1, array.length) );\n    var iqr = q3[1] - q1[1]; //The interquartile range\n    var tlo = q1[1] - 1.5 * iqr ;//low threshold\n    var thi = q3[1] + 1.5 * iqr ;//high threshold\n    if (type == \"high\") {\n        return (thi + (thi/100*20));\n    }\n    return tlo;\n}\n\nfunction getMedian (m) {\n    var middle = Math.floor((m.length - 1) / 2); // NB: operator precedence\n    if (m.length % 2) {\n        return [middle, m[middle]];\n    } else {\n        return [middle, (m[middle] + m[middle + 1]) / 2.0];\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":360,"wires":[["94bb4577.4f15a8"]]},{"id":"736d9b22.c032b4","type":"function","z":"2165caf7.2f0b96","name":"Rule 5","func":"var linearHallValue=global.get(\"linearHallValue\");\nvar linearHallArray= global.get(\"linearHallArray\");\nvar completeCheck= global.get(\"completeCheck\") || false;\nvar isAlarmOn= global.get(\"isAlarmOn\");\n\nvar msg1;\nmsg1={payload:\"okrule5\"};\n\nif( completeCheck\n    && !isAlarmOn\n    && (linearHallValue < computeThreshold(linearHallArray,\"low\")\n    || linearHallValue > computeThreshold(linearHallArray,\"high\"))) {\n    msg1={payload:\"05rule5\"}\n    global.set(\"isAlarmOn\", true);\n}\nreturn msg1;\n\nfunction computeThreshold(array,type) {\n    var q2 = getMedian(array);\n    var q1 = getMedian( array.slice(0, q2[0]+1) );\n    var q3 = getMedian( array.slice(q2[0]+1, array.length) );\n    var iqr = q3[1] - q1[1]; //The interquartile range\n    var tlo = q1[1] - 1.5 * iqr ;//low threshold\n    var thi = q3[1] + 1.5 * iqr ;//high threshold\n    if (type == \"high\") {\n        return (thi + (thi/100*20));\n    }\n    return (tlo - (tlo/100*20));\n}\n\nfunction getMedian (m) {\n    var middle = Math.floor((m.length - 1) / 2); // NB: operator precedence\n    if (m.length % 2) {\n        return [middle, m[middle]];\n    } else {\n        return [middle, (m[middle] + m[middle + 1]) / 2.0];\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":420,"wires":[["4f8915f9.62f9bc"]]},{"id":"ae703bdd.0c0358","type":"function","z":"2165caf7.2f0b96","name":"Rule 6","func":"var completeCheck= global.get(\"completeCheck\");\nvar isAlarmOn= global.get(\"isAlarmOn\");\nvar gpsArray= global.get(\"gpsArray\");\nvar lat2 = global.get(\"gpsValueLat\");\nvar lon2 = global.get(\"gpsValueLon\");\nvar coordinates, distance;\nvar msg1={payload:\"okrule6\"};\n\nif (completeCheck && !isAlarmOn) {\n    coordinates = moreFrequentlyItem(gpsArray);\n    distance = computeDistance(parseFloat(coordinates[0]), parseFloat(coordinates[1]),lat2,lon2);\n    if (distance > 0.2) {\n        msg1={payload:\"05rule6\"};\n        global.set(\"isAlarmOn\", true);\n    }\n}\n\nreturn msg1;\n\nfunction computeDistance (lat1, lon1, lat2, lon2) {\n    var R = 6371; //radius of the earth in Km\n    var x = (lon2-lon1)* Math.cos(0.5*(lat2+lat1));\n    var y = lat2 - lat1;\n    return R * Math.sqrt (x*x + y*y);\n}\n\nfunction moreFrequentlyItem(arr) {\n  var maxFreq = 1;\n  var counter = 0;\n  var item = [];\n  for (var i=0; i<arr.length; i++) {\n    for (var j=i; j<arr[i].length; j++) {\n        if (arr[i][0] == arr[j][0] && arr[i][1] == arr[j][1]) {\n            counter++;\n        }\n        if (maxFreq<counter) {\n            maxFreq=counter;\n            item = arr[i];\n        }\n    }\n    m=0;\n  }\n  return item;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":480,"wires":[["187d3787.8597c8"]]},{"id":"c134b638.91bc08","type":"function","z":"2165caf7.2f0b96","name":"Rule 7","func":"\n//Get global variables\nvar completeCheck = global.get(\"completeCheck\");\nvar isAlarmOn = global.get(\"isAlarmOn\");\nvar zAccellerometerArray=global.get(\"zAccellerometerArray\");\nvar zAccellerometerValue = global.get(\"zAccellerometerValue\");\n\nvar msg1={payload:\"okrule7\"};\n    \nif(completeCheck && !isAlarmOn) {\n    \n    //extract array to compute the threshold\n    var zAccellerometerThi=computeThreshold(zAccellerometerArray,\"high\");\n    var zAccellerometerTlo=computeThreshold(zAccellerometerArray,\"low\");\n    \n    if ( zAccellerometerValue < zAccellerometerTlo ||  zAccellerometerValue > zAccellerometerThi) {\n         msg1={payload:\"05rule7\"}\n        global.set(\"isAlarmOn\", true);\n    }\n}\nreturn msg1;\n\nfunction computeThreshold(array,type) {\n    var q2 = getMedian(array);\n    var q1 = getMedian( array.slice(0, q2[0]+1) );\n    var q3 = getMedian( array.slice(q2[0]+1, array.length) );\n    var iqr = q3[1] - q1[1]; //The interquartile range\n    var tlo = q1[1] - 1.5 * iqr ;//low threshold\n    var thi = q3[1] + 1.5 * iqr ;//high threshold\n    if (type == \"high\") {\n        return (thi + (thi/100*20));\n    }\n    return (tlo - (tlo/100*20));\n}\n\nfunction getMedian (m) {\n    var middle = Math.floor((m.length - 1) / 2); // NB: operator precedence\n    if (m.length % 2) {\n        return [middle, m[middle]];\n    } else {\n        return [middle, (m[middle] + m[middle + 1]) / 2.0];\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":540,"wires":[["5cd40416.e3471c"]]},{"id":"cb83197e.0028a8","type":"trigger","z":"2165caf7.2f0b96","name":"trigger rule1","op1":"","op2":"","op1type":"pay","op2type":"payl","duration":"0","extend":false,"overrideDelay":false,"units":"ms","reset":"okrule1","bytopic":"all","topic":"topic","outputs":1,"x":570,"y":180,"wires":[["e17eae33.8c475"]]},{"id":"8a1f2d0.722b8d","type":"trigger","z":"2165caf7.2f0b96","name":"trigger rule2","op1":"","op2":"","op1type":"pay","op2type":"payl","duration":"0","extend":false,"overrideDelay":false,"units":"ms","reset":"okrule2","bytopic":"all","topic":"topic","outputs":1,"x":570,"y":240,"wires":[["e17eae33.8c475"]]},{"id":"276b4828.dcdf38","type":"trigger","z":"2165caf7.2f0b96","name":"trigger rule3","op1":"","op2":"","op1type":"pay","op2type":"payl","duration":"0","extend":false,"overrideDelay":false,"units":"ms","reset":"okrule3","bytopic":"all","topic":"topic","outputs":1,"x":570,"y":300,"wires":[["e17eae33.8c475"]]},{"id":"94bb4577.4f15a8","type":"trigger","z":"2165caf7.2f0b96","name":"trigger rule4","op1":"","op2":"","op1type":"pay","op2type":"payl","duration":"0","extend":false,"overrideDelay":false,"units":"ms","reset":"okrule4","bytopic":"all","topic":"topic","outputs":1,"x":570,"y":360,"wires":[["e17eae33.8c475"]]},{"id":"4f8915f9.62f9bc","type":"trigger","z":"2165caf7.2f0b96","name":"trigger rule5","op1":"","op2":"","op1type":"pay","op2type":"payl","duration":"0","extend":false,"overrideDelay":false,"units":"ms","reset":"okrule5","bytopic":"all","topic":"topic","outputs":1,"x":570,"y":420,"wires":[["e17eae33.8c475"]]},{"id":"187d3787.8597c8","type":"trigger","z":"2165caf7.2f0b96","name":"trigger rule6","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"0","extend":false,"overrideDelay":false,"units":"ms","reset":"okrule6","bytopic":"all","topic":"topic","outputs":1,"x":570,"y":480,"wires":[["e17eae33.8c475"]]},{"id":"5cd40416.e3471c","type":"trigger","z":"2165caf7.2f0b96","name":"trigger rule7","op1":"","op2":"","op1type":"pay","op2type":"payl","duration":"0","extend":false,"overrideDelay":false,"units":"ms","reset":"okrule7","bytopic":"all","topic":"topic","outputs":1,"x":570,"y":540,"wires":[["e17eae33.8c475"]]},{"id":"e17eae33.8c475","type":"mqtt out","z":"2165caf7.2f0b96","name":"Alarm","topic":"atm-group3-00","qos":"2","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"fb7c421f.802b9","x":830,"y":360,"wires":[]},{"id":"1149544f.8d3a7c","type":"link in","z":"2165caf7.2f0b96","name":"Array - IN","links":["4e2cc658.d56b98"],"x":195,"y":360,"wires":[["2f57c29c.d079ee","7c2c3337.05c06c","d1348304.cd819","3340b93d.7d7ea6","736d9b22.c032b4","ae703bdd.0c0358","c134b638.91bc08","4b5cf209.d3d2bc"]]},{"id":"4b5cf209.d3d2bc","type":"function","z":"2165caf7.2f0b96","name":"Check arrays","func":"var arraySize = global.get(\"arraySize\") || 20;\nvar completeCheck= global.get(\"completeCheck\") || false;\nvar temperatureArray= global.get(\"temperatureArray\");\nvar brightnessArray= global.get(\"brightnessArray\");\nvar microphoneArray= global.get(\"microphoneArray\");\nvar linearHallArray= global.get(\"linearHallArray\");\nvar gpsArray= global.get(\"gpsArray\");\nvar zAccellerometerArray= global.get(\"zAccellerometerArray\");\nvar isAlarmOn = global.get(\"isAlarmOn\") || false;\n\nif (typeof temperatureArray !== 'undefined'\n    && typeof microphoneArray !== 'undefined'\n    && typeof linearHallArray !== 'undefined'\n    && typeof brightnessArray !== 'undefined'\n    && typeof gpsArray !== 'undefined'\n    && typeof zAccellerometerArray !== 'undefined') {\n        if (temperatureArray.length === arraySize\n            && microphoneArray.length == arraySize\n            && linearHallArray.length == arraySize\n            && brightnessArray.length == arraySize\n            && gpsArray.length == arraySize\n            && zAccellerometerArray.length == arraySize) {\n                completeCheck=true;\n        }   \n}\n\nglobal.set(\"completeCheck\", completeCheck);\nglobal.set(\"isAlarmOn\", isAlarmOn);","outputs":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":120,"wires":[]},{"id":"fb7c421f.802b9","type":"mqtt-broker","name":"","broker":"paologas91.chickenkiller.com","port":"1883","clientid":"node-RED-group3","usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"sessionExpiry":""}]